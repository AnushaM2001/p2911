{% extends 'layouts/main.html' %}
{% load static %}
{% block title %}
<title>Shopping Page</title>

{% endblock title %}

{% block extra_css %}

 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{% static 'css/home.css' %}?v2" type="text/css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
 
    <!-- Load jQuery first -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
    <!-- Now your own custom AJAX script -->
    
  

  <style>
    body {
      background-color: #F7E7E8;;
    }
    .custom-box {
      background-color: #FBF0EF;
      border-radius: 8px;
    }
    .card {
      border: none;
      background-color: #FBF0EF;
    }
    .price-text {
      font-weight: bold;
    }
    .strike {
      text-decoration: line-through;
      color: grey;
    }
    .discount {
      color: green;
      font-weight: 500;
    }
    .gift-icon {
      color: #c70039;
      font-size: 1.2rem;
    }
    .btn-theme {
        
        border-radius: 500px;
        background-color: #981945;
        color: white;
        padding: 10px 14px;
        font-family: Jomolhari;
font-size: 13px;
font-style: normal;
font-weight: 400;
line-height: 18px;
        
    }
    .btn-theme:hover{
        background-color: #981945;
        color: white;


    }
    .btn-theme-pay {
      background: linear-gradient(90deg, #981942 0%, #CC3D70 50%, #981942 100%);
      border-radius: 500px !important;
      width: 140px;
      padding: 15px 0  !important;
      justify-content: center;
      align-items: center;
      display: flex;
      color: white;
      font-family: 'Jomolhari';
      font-size: 14px;
      font-weight: 400;
      line-height: 18px;
      border: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
}
.back-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  background: #6D3F0B;
  color: white;
  border: none;
  padding: 10px 16px;
  font-size: 14px;
  border-radius: 5px;
  text-decoration: none;
  z-index: 999;
}
.back-btn:hover {
  background-color: #4f2e08;
}
/* Responsive Media Queries by kartheek*/
 @media (max-width: 992px) {
    .custom-box,
    .card,
    .cont {
      padding: 1rem;
    }
    .btn-theme,
    .btn-theme-pay {
      width: 100%;
      font-size: 13px;
    }
    .d-flex.p-3.mb-3 {
      flex-direction: row;
      align-items: flex-start;
    }
    .d-flex.p-3.mb-3 img {
      width: 120px;
      height: auto;
    }
    .d-flex.p-3.mb-3 .ms-4.mt-4 {
      margin-top: 0 !important;
      margin-left: 1rem !important;
      text-align: left;
    }
    .btn-theme-pay {
      width: 100% !important;
    }
    .input-group {
      flex-direction: column;
    }
    #premium-offer-section .form-control {
      margin-bottom: 10px;
      width: 100%;
    }
    #premium-offer-section .btn {
      width: 100%;
      height:fit-content;
    }
    #gift-wrap-button{
    font-size:10px;
  }
  }

  @media (max-width: 768px) {
    .container {
      padding: 0 15px;
    }
    .col-md-8,
    .col-md-4 {
      flex: 0 0 100%;
      max-width: 100%;
    }
    .btn-theme {
      padding: 10px;
      font-size: 12px;
    }
    .btn-theme-pay {
      padding: 10px 0;
      font-size: 13px;
    }
    .strike, .discount, .price-text {
      display: block;
      margin-top: 5px;
    }
    .d-inline-flex.align-items-center {
      flex-wrap: wrap;
      justify-content: center;
    }
    .gift-icon {
      font-size: 1.2rem;
    }
    .cont {
      margin-top: 30px !important;
    }
    #gift-wrap-message {
      font-size: 14px;
      margin-top: 10px;
    }
    #gift-wrap-button{
        font-size:10px;
}
  }

  @media (max-width: 576px) {
    h6, .fw-bold, .price-text {
      font-size: 14px !important;
    }
    .btn-theme, .btn-theme-pay {
      font-size: 12px !important;
      padding: 10px 0 !important;
    }
    .d-flex.justify-content-between {
     
      align-items: flex-start;
      gap: 0.5rem;
    }
    .d-flex.align-items-center {
      
      gap: 0.5rem;
    }
    .coupon span {
      font-size: 13px;
    }
    .remove-form button {
      font-size: 13px;
    }
    .custom-box {
      margin-bottom: 1rem;
    }
    .toast {
      width: 90%;
      font-size: 14px;
    }

    #gift-wrap-button{
        font-size:10px;
}

  }
  .stars-outer {
  position: relative;
  display: inline-block;
  color: #ccc;
  font-size: 1.1rem;
}

.stars-inner {
  position: absolute;
  top: 0;
  left: 0;
  white-space: nowrap;
  overflow: hidden;
  color: #ffc107;
}

.update-quantity-form button:active {
    transform: scale(0.95);
}
@media(max-width:578px){
  .img-thumbnail{
    width:200px !important;
  }
}

.img-thumbnail {
  transition: transform 0.3s ease-in-out;
}

.img-thumbnail:hover {
  transform: scale(1.1);
}

html, body {
    overflow-x: hidden;
    max-width: 100%;
}
  </style>
  

{% endblock extra_css %}

{% block content %}

<div class="container py-5">
  
  <div class="row">
    <!-- Left Column -->
    <div class="col-md-8">

      <!-- Delivery To Title -->
      <div class="mb-2 p-3 custom-box shadow-sm d-flex justify-content-between align-items-center">
        <p class="mb-0 fw-bold" style="color: #981942;">
          <i class="bi bi-geo-alt-fill me-2"></i>Delivery To
        </p>
        <a href="{% url 'add_address' %}" class="text-decoration-none" style="color: var(--color-saddlebrown);">Select Address National/international</a>
      </div>

       <!-- <div class="mb-2 p-3 custom-box shadow-sm d-flex justify-content-between align-items-center">
        <p class="mb-0 fw-bold" style="color: #981942;">
          <i class="bi bi-geo-alt-fill me-2"></i>International Orders
        </p>
        <a href="{% url 'international_order' %}" class="text-decoration-none" style="color: var(--color-saddlebrown);">Select</a>
      </div> -->
     
      

      <!-- Address Section -->
      <div class="mb-3 p-3 custom-box shadow-sm d-flex justify-content-between align-items-start">
        <div>
          <i class="bi bi-person-circle me-2"></i>
          {% if address %}
          <strong>{{ address.Name }}</strong> |{{ address.location }}, {{ address.City}}, {{ address.State}} - {{ address.Pincode}}
          {% else %}
          <strong>No Address Found</strong>
          {% endif %}
        </div>
        <div>
          {% if address %}
          <a href="{% url 'update_address' address_id=address.id %}" class="text-decoration-none" style="color: var(--color-saddlebrown);">Change</a>
          
          {% endif %}

        </div>
      </div>


      <!-- Product Section -->
      {% for item in cart_items %}
      <div class="d-flex p-3 mb-3">
        {% if item.product %}
        <a href="{% url 'product_detail' item.product.id %}"><img src="{{ item.product.image1.url }}" class="img-thumbnail" style="width: 150px; height:auto; border:none; border-radius: 10px;" alt="Product Image"></a>
        {% endif %}
        <div class="ms-4 mt-4">
          <h6>{{ item.product.name }}</h6>
           {% if item.flavour_names %}
  <p><strong>Selected Flavours:</strong> {{ item.flavour_names }}</p>
{% endif %}


          <div class="d-flex align-items-center">
            
            {% if item.gift_set %}
{% if item.offer_applied and item.offer_applied.premium_festival == "Festival" %}
        <span class="text-success font-weight-bold">‚Çπ{{ item.discounted_price|floatformat:2  }}</span>
        <del class="text-muted" style="margin-left:10px;">‚Çπ{{ item.gift_set.price }}</del>
        {% if item.offer_applied %}
          <br><small class="text-danger"> ({{ item.offer_applied.percentage }}% off)</small>
        {% endif %}
        {% else %}
            <span class="price-text">‚Çπ{{ item.price }}</span>
            <span class="ms-2 strike">‚Çπ{{ item.original_price }}</span>
            <span class="ms-2 discount">{{ item.product.offer }}</span>
            {% endif %}
            
          {% elif item.product_variant %}
{% if item.offer_applied and item.offer_applied.premium_festival == "Festival" %}
        <span class="text-success font-weight-bold">‚Çπ{{ item.discounted_price|floatformat:2  }}</span>
        <del class="text-muted" style="margin-left:10px;">‚Çπ{{ item.original_price }}</del>
        {% if item.offer_applied %}
          <br><small class="text-danger"> ({{ item.offer_applied.percentage }}% off)</small>
        {% endif %}
        {% else %}
            <span class="price-text">‚Çπ{{ item.product_variant.price }}</span>
            <span class="ms-2 strike">‚Çπ{{ item.product_variant.original_price }}</span>
            <span class="ms-2 discount">{{ item.product.offer }}</span>
          {% endif %}
        
          {% else %}
            <span class="price-text">‚Çπ{{ item.product.price }}</span>
          {% endif %}
          </div>
         {% if item.average_rating %}
<div class="d-flex align-items-center gap-2 mb-2">
  <div class="stars-outer position-relative" style="color: #ccc; font-size: 1.1rem;">
    <div class="stars-inner position-absolute top-0 start-0" style="width: {{ item.rating_percentage }}%; color: #AF9164; white-space: nowrap; overflow: hidden;">
      ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
    </div>
    ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
  </div>
  <span class="text-muted" style="font-size: 0.85rem;">({{ item.average_rating|floatformat:1 }} / 5)</span>
</div>
{% endif %}

      <div class="mt-2 d-flex align-items-center">
          <form method="POST" action="{% url 'update_cart_item' item.id %}" 
                class="d-flex mt-2 align-items-center update-quantity-form"
                data-item-id="{{ item.id }}">
              {% csrf_token %}
              {% if item.product_variant %}
              <input type="hidden" name="variant_id" value="{{ item.product_variant.id }}">
              {% else %}
              <input type="hidden" name="variant_id" value="">
              {% endif %}
              
              {% if item.gift_set %}
              <input type="hidden" name="gift_set_id" value="{{ item.gift_set.id }}">
              {% else %}
              <input type="hidden" name="gift_set_id" value="">
              {% endif %}
              
              <label class="me-2 mb-0">Qty:</label>
              <div class="d-inline-flex align-items-center border border-dark rounded-pill px-2 py-1 shadow-sm">
                  <button type="button" class="btn btn-link p-0 px-2 text-dark text-decoration-none decrease-btn">-</button>
                  <span class="mx-2 quantity-display">{{ item.quantity }}</span>
                  <button type="button" class="btn btn-link p-0 px-2 text-dark text-decoration-none increase-btn">+</button>
              </div>
          </form>
      </div>
          
          <!-- <p class="mt-2 text-muted small"><i class="bi bi-calendar3"></i> Expected Delivery 24 Dec</p> -->
          <div class="cart-item" data-item-id="{{ item.id }}">
              <!-- Item details, image, name, price -->

              <form method="POST" action="{% url 'remove_cart_item' item.id %}" 
                  class="remove-form" data-item-id="{{ item.id }}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-link text-danger small p-0">
                      Remove
                  </button>
              </form>
          </div>


        </div>
      </div>
      {% endfor %}

      <!-- Gift Wrap -->
      <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
        <div class="d-flex align-items-center">
          <i class="bi bi-gift gift-icon me-2" style="font-size: 1.5rem;"></i>
          <span class="fs-6">Do you want a gift box with wrap? Only ‚Çπ150</span>
        </div>
   <form method="post" action="{% url 'toggle_gift_wrap' %}" id="gift-wrap-form">
    {% csrf_token %}
    <button type="submit" 
            class="btn"
            id="gift-wrap-button" style="background-color: maroon; color: white;" >
        {% if request.session.gift_wrap %}
            Remove Gift Wrap
        {% else %}
            Gift Box with Wrap
        {% endif %}
    </button>
</form>

<div id="gift-wrap-message" class="text-success mb-3"
     {% if not request.session.gift_wrap %}style="display:none;"{% endif %}>
    üéÅ Gift Wrap Applied (+‚Çπ150)
</div>

    
</div>
    
      <!-- Pay Now -->
       
      <div class="cont p-3" style="background-color: #FBF0EF; border-radius: 12px; margin-top: 60px;">
        
        <div class="d-flex justify-content-end">
          
          {% if address.id %}
            <button type="button" id="pay-button" class="btn btn-theme-pay" style="color:white;">Pay Now</button>
          {% else %}
            <button type="button" id="fill-address-button" class="btn btn-theme-pay" style="color: white;">Add Address</button>
          {% endif %}
          

          
        </div>

      </div>
      
</div>


 

    <!-- Right Column -->
   
    <div class="col-md-4">
      {% if error_messages %}
  {% for message in error_messages %}
      <div class="auto-clear-msg alert alert-danger">{{ message }}</div>
  {% endfor %}
{% elif success_messages %}
  {% for message in success_messages %}
      <div class="auto-clear-msg alert alert-success">{{ message }}</div>
  {% endfor %}
  
  <!-- Check if there are any success messages -->
  <script>
      document.addEventListener('DOMContentLoaded', function () {
          if ({{ success_messages|length }} > 0) {
              confetti({
                  particleCount: 200,
                  spread: 100,
                  startVelocity: 40,
                  origin: { y: 0.6 }
              });
          }
      });
  </script>
{% endif %}

  
  


      <!-- Coupon Section -->
       <div class="p-3 custom-box shadow-sm mb-3" style="background-color: #FBF0EF;">
        
        <h6 class="d-flex align-items-center mb-3">
          <img src="{% static 'images2/vector.png' %}" height="25" width="25">Apply Coupon
        </h6>
        
        <!-- Premium/Festive Offer Input -->
        
          <div class="input-group mb-3" id="premium-offer-section">
  <form id="premium-offer-form" class="d-flex w-100">
    {% csrf_token %}
    <input
      type="text"
      id="premium-offer-code"
      name="code"
      class="form-control"
      placeholder="Enter code"
      value="{{ premium_offer_code|default:'' }}"
      {% if premium_offer_code %}readonly{% endif %}
      required
    >
    <button
      type="submit"
      id="premium-offer-btn"
      class="btn btn-outline-transparent bg-white"
      style="color: var(--color-saddlebrown);"
      data-action="{% if premium_offer_code %}remove{% else %}apply{% endif %}">
      {% if premium_offer_code %}Remove{% else %}Apply{% endif %}
    </button>
  </form>
</div>


<div id="premium-offer-message" style="margin-top:10px;"></div>

    
        <div class="p-2" style="background-color: #fff; border-radius: 5px;">
          <p class="mb-1 fw-bold">Applicable</p>
      {% if welcome_offer %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <span class="fw-bold">üéâ Welcome Offer</span><br>
    <small class="text-muted">
      Use code
      <span class="text-primary">{{ welcome_offer.code }} Get {{ welcome_offer.percentage }}% off</span>
      on your first order
    </small>
  </div>
</div>
{% endif %}





    
          <!-- Coupon 1 -->
          {% for coupon in all_coupons %}
          <div class="d-flex justify-content-between mb-2">
              <div class="coupon
                  {% if coupon in eligible_coupons and coupon.id not in used_coupons %}
                      active
                  {% else %}
                      inactive
                  {% endif %}
              ">
                  <span class="fw-bold">{{ coupon.code }}</span>
                  
                  {% if coupon.id in used_coupons %}
                      <span class="text-danger">Already used ‚Çπ{{ coupon.discount }}</span>
                  {% elif coupon not in eligible_coupons %}
                      <button
  class="btn btn-outline-secondary btn-sm"
  data-code="{{ coupon.code }}"
  data-required="{{ coupon.required_amount }}"
  data-discount="{{ coupon.discount }}"
  disabled>
  Apply Coupon
                      
</button>
 
                          
                  {% else %}
                      <span class="text-danger">Shop above ‚Çπ{{ coupon.required_amount }}<span style="color: green; font-weight: bold;">Save ‚Çπ{{ coupon.discount }}</span>
                      </span>
                  {% endif %}
              </div>
          
             <div class="text-end">
    {% if coupon.code == request.session.applied_coupon %}
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" disabled>
                Applied
            </button>

            <button
              class="btn btn-danger btn-sm remove-coupon-btn">
              Remove
            </button>
        </div>

    {% elif coupon in eligible_coupons and coupon.id not in used_coupons %}
       <button
  class="btn btn-outline-primary btn-sm apply-coupon-btn"
  data-code="{{ coupon.code }}"
  data-required="{{ coupon.required_amount }}"
  data-discount="{{ coupon.discount }}">
  Apply Coupon
</button>
   {% endif %}
</div>

          </div>
          <hr>
          {% endfor %}
          
    
          <!-- Coupon 2 -->
          
        </div>
      </div>
    
    <div id="coupon-success-msg"
     class="alert alert-success mt-2"
     style="display:none;">
</div>


    <!-- Order Summary -->
    

      <!-- Order Summary change==================== -->
<div class="p-3 custom-box shadow-sm">
    <h6>Order Details</h6>
    <div class="d-flex justify-content-between mb-2">
        <span> Price(Products)</span>
        <span data-price="subtotal">‚Çπ{{ amount|floatformat:2 }}</span>
    </div>
    <div class="d-flex justify-content-between mb-2">
        <span>Delivery Charge</span>
        <span data-price="delivery">‚Çπ{{ delivery_charges|floatformat:2 }}</span>
    </div>
    <div class="d-flex justify-content-between mb-2">
        <span>Platform Fee</span>
        <span data-price="platform_fee">‚Çπ{{ platform_fee|floatformat:2 }}</span> 
    </div>
   
<div id="coupon-discount-row"
     class="d-flex justify-content-between mb-2"
     style="display:none;">
    <span>Discount</span>
    <span data-price="discount" class="text-success">-‚Çπ0.00</span>
</div>

    
    {% if gift_wrap_display %}
    <div class="d-flex justify-content-between mb-2">
        <span>Gift Wrap</span>  
        <span data-price="gift_wrap" style="color: green;">+‚Çπ{{ gift_wrap_display|floatformat:2 }}</span>    
    </div>
    {% endif %}

       
   <div id="premium-discount-row"
     class="d-flex justify-content-between mb-2"
     style="display:none;">
    <span id="premium-label">Premium Discount</span>
    <span data-price="premium_discount" class="text-success">-‚Çπ0.00</span>
</div>

    
    <hr>
    
    <div class="d-flex justify-content-between fw-bold">
        <span>Amount Payable:</span>
        <span data-price="total">‚Çπ{{ total_price|floatformat:2 }}</span>
    </div>
</div>
    </div>
  </div>
</div>


<div id="toast" class="toast position-fixed bottom-0 end-0 m-3 bg-success text-white" role="alert" style="display: none; z-index: 9999;">
  <div class="toast-body">
    Item removed from cart
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {

    // ---------- REMOVE ITEM ----------
    document.querySelectorAll('.remove-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {

                    const cartItem = document.querySelector(
                        `.cart-item[data-item-id="${this.dataset.itemId}"]`
                    );
                    if (cartItem) {
                        const wrapper = cartItem.closest('.d-flex.p-3.mb-3');
                        if (wrapper) wrapper.remove();
                    }

                    refreshOrderSummary();
                }
            });
        });
    });

    // ---------- QUANTITY UPDATE ----------
    document.querySelectorAll('.update-quantity-form').forEach(form => {
        const quantityDisplay = form.querySelector('.quantity-display');
        const itemId = form.dataset.itemId;

        form.querySelector('.increase-btn').onclick = () =>
            updateQuantity(form, itemId, 'increase', quantityDisplay);

        form.querySelector('.decrease-btn').onclick = () => {
            if (parseInt(quantityDisplay.textContent) > 1) {
                updateQuantity(form, itemId, 'decrease', quantityDisplay);
            }
        };
    });

    function updateQuantity(form, itemId, action, quantityDisplay) {
        const formData = new FormData(form);
        formData.append('action', action);

        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                quantityDisplay.textContent = data.new_quantity;
                refreshOrderSummary();
            }
        });
    }

    // ---------- BACKEND-DRIVEN SUMMARY ----------
    function refreshOrderSummary() {
    fetch('/sync-redis-cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {

            // Totals
            updateOrderSummary(data.order_summary);

            // Quantities
            if (data.quantities) {
                Object.entries(data.quantities).forEach(([itemId, qty]) => {
                    const el = document.querySelector(
                        `.cart-item[data-item-id="${itemId}"] .quantity-display`
                    );
                    if (el) el.textContent = qty;
                });
            }

            // Cart count
            document.querySelectorAll('.cart-count').forEach(el => {
                el.textContent = data.cart_count;
            });

            // üî• AUTO ENABLE COUPONS
            updateCouponEligibilityUI(data.eligible_coupons);
        }
    });
}


    // ---------- DISPLAY ONLY ----------
  

});
</script>

<script>
function updateCouponEligibilityUI(eligibleCoupons) {

    document.querySelectorAll('[data-code]').forEach(btn => {
        const code = btn.dataset.code;
        if (!code) return;

        // Skip applied coupon
        if (btn.dataset.applied === "true") return;

        const required = btn.dataset.required;
        const discount = btn.dataset.discount;

        if (eligibleCoupons.includes(code)) {
            // ‚úÖ Eligible
            btn.innerHTML = 'Apply Coupon';
            btn.disabled = false;
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-primary', 'apply-coupon-btn');

        } else {
            // ‚ùå Not eligible ‚Üí SHOW MESSAGE
            btn.innerHTML = `
                
                <p class="text-muted">Apply coupon</p>
            `;
            btn.disabled = true;
            btn.classList.remove('btn-outline-primary', 'apply-coupon-btn');
            btn.classList.add('btn-outline-secondary');
        }
    });
}
</script>

<script>
window.updateOrderSummary = function (prices, meta = {}) {

    const set = (key, val, negative=false) => {
        const el = document.querySelector(`[data-price="${key}"]`);
        if (!el) return;

        const num = parseFloat(val) || 0;
        el.textContent = (negative ? '-‚Çπ' : '‚Çπ') + num.toFixed(2);
    };

    // ---- SET VALUES ----
    set('subtotal', prices.subtotal);
    set('delivery', prices.delivery);
    set('platform_fee', prices.platform_fee);
    set('gift_wrap', prices.gift_wrap || 0);
    set('discount', prices.discount, true);
    set('premium_discount', prices.premium_discount, true);
    set('total', prices.total || prices.final_total);

    // ---- COUPON ROW VISIBILITY ----
    const couponRow = document.getElementById('coupon-discount-row');
    const couponAmount = Number(prices.discount || 0);

    couponRow.style.display = couponAmount > 0 ? 'flex' : 'none';

    // -------- PREMIUM / WELCOME ROW --------
    const premiumRow = document.getElementById('premium-discount-row');
    const premiumLabel = document.getElementById('premium-label');
    const premiumAmount = Number(prices.premium_discount || 0);

    if (premiumAmount > 0) {
        premiumRow.style.display = 'flex';
        premiumLabel.textContent =
            meta.welcome ? 'Welcome Discount' : 'Premium Discount';
    } else {
        premiumRow.style.display = 'none';
    }
};

</script>




<!-- Razorpay script -->
<!-- <script src="https://checkout.razorpay.com/v1/checkout.js"></script> -->

<script>
  const hasAddress = {{ address.id|yesno:"true,false" }};
  const redirectUrl = "{% url 'add_address' %}";
  const keyId = "{{ key_id }}";
  const Amount = "{{ amount_in_paise }}";  // in paise
  const orderId = "{{ razorpay_order_id }}";
  const userEmail = "{{ request.user.email }}";
  const userName = "{{ request.user.get_full_name }}";
  const totalPrice = "{{ total_price }}";
  const csrfToken = "{{ csrf_token }}";
  const orderSuccessUrl = "{% url 'order_success' %}";

  let hasSubmitted = false;

  document.addEventListener('DOMContentLoaded', function () {
    const payBtn = document.getElementById('pay-button');
    const fillAddressBtn = document.getElementById('fill-address-button');
    
    const redirectUrl = "{% url 'add_address' %}?next={{ request.path }}";

    if (hasAddress) {
      payBtn?.addEventListener('click', function (e) {
        e.preventDefault();
        initiatePayment();
      });
    } else {
      fillAddressBtn?.addEventListener('click', function () {
        alert("Please fill in your address before proceeding to payment.");
        window.location.href = redirectUrl;
      });
    }
  });

  
function initiatePayment() {
    const options = {
      "key": keyId,
      "amount": Amount,
      "currency": "INR",
      "name": "Perfume Valley",
      "description": "Order Payment",
      "order_id": orderId,
      "prefill": {
        "name": userName,
        "email": userEmail
      },
      "theme": {
        "color": "#F37254"
      },
      "handler": function (response) {
        if (hasSubmitted) return;
        hasSubmitted = true;

        // Create form dynamically to POST to success view
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = orderSuccessUrl;

        const fields = {
          'csrfmiddlewaretoken': csrfToken,
          'razorpay_payment_id': response.razorpay_payment_id,
          'razorpay_order_id': response.razorpay_order_id,
          'razorpay_signature': response.razorpay_signature,
          'total_price': totalPrice
        };

        for (let key in fields) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = key;
          input.value = fields[key];
          form.appendChild(input);
        }

        document.body.appendChild(form);
        form.submit();
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  }
</script>

<script>
  function handleCouponApply(form) {
      // Find the button inside the form
      var button = form.querySelector('.apply-button');
      
      // Immediately change button text and disable it
      button.innerText = "Applied";
      button.disabled = true;
      button.style.color = 'gray'; // Optional: style it grey to show disabled
  
      // Allow form submission
      return true;
  }
  </script>
  <script>
    const applyButtons = document.querySelectorAll('.apply-button');
    applyButtons.forEach(btn => {
        btn.innerText = 'Applied';
        btn.disabled = true;
        btn.style.opacity = '0.6';
        return true;
    });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('gift-wrap-form');
      const button = document.getElementById('gift-wrap-button');
      const message = document.getElementById('gift-wrap-message');

      form.addEventListener('submit', function (event) {
          event.preventDefault();  // stop default form submit temporarily

          // Toggle button text
          if (button.innerText.trim() === 'Gift Box With Wrap') {
              button.innerText = 'Remove Gift Wrap';
              message.style.display = 'block';  // Show the gift wrap message
          } else {
              button.innerText = 'Gift Box With Wrap';
              message.style.display = 'none';  // Hide the gift wrap message
          }

          // Now submit the form after toggling
          form.submit();
      });
  });
</script>
<script>
  setTimeout(function () {
    const msgs = document.querySelectorAll('.auto-clear-msg');
    msgs.forEach(function (msg) {
      msg.style.transition = 'opacity 1s';
      msg.style.opacity = '0';
      setTimeout(() => msg.remove(), 1000);  // remove after fade
    });
  }, 6000); // 1 minute
</script>

<script>
document.getElementById('premium-offer-form').addEventListener('submit', function (e) {
    e.preventDefault();

    const btn = document.getElementById('premium-offer-btn');
    const input = document.getElementById('premium-offer-code');
    const message = document.getElementById('premium-offer-message');
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const action = btn.dataset.action;
    const url = action === 'apply'
        ? "{% url 'apply_premium_coupon' %}"
        : "{% url 'remove_premium_offer' %}";

    const body = action === 'apply'
        ? new URLSearchParams({ code: input.value })
        : new URLSearchParams();

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrf,
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: body
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {

            // üîÅ Update totals instantly
            updateOrderSummary(data.totals);

            if (action === 'apply') {
                input.readOnly = true;
                btn.textContent = 'Remove';
                btn.dataset.action = 'remove';
            } else {
                input.readOnly = false;
                input.value = '';
                btn.textContent = 'Apply';
                btn.dataset.action = 'apply';
            }

            message.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else {
            message.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(() => {
        message.innerHTML = `<div class="alert alert-danger">Something went wrong</div>`;
    });
});
</script>



  
<script>
document.addEventListener("click", function (e) {

    // APPLY COUPON
    if (e.target.classList.contains("apply-coupon-btn")) {
    e.preventDefault();

    fetch("{% url 'apply_coupon' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
            code: e.target.dataset.code
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {

            // ‚úÖ INSTANT UI UPDATE
            updateOrderSummary({
                subtotal: data.totals.products_total,
                delivery: data.totals.delivery,
                platform_fee: data.totals.platform_fee,
                gift_wrap: data.totals.gift_wrap,
                discount: data.totals.coupon_discount,
                premium_discount: data.totals.premium_discount,
                total: data.totals.final_total
            });
             markCouponApplied(e.target.dataset.code, data.totals.coupon_discount);
           

        } else {
            alert(data.message);
        }
    });
}


    // REMOVE COUPON
    if (e.target.classList.contains("remove-coupon-btn")) {
    e.preventDefault();

    fetch("{% url 'remove_coupon' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {

            // ‚úÖ INSTANT UI UPDATE
            updateOrderSummary({
                subtotal: data.totals.products_total,
                delivery: data.totals.delivery,
                platform_fee: data.totals.platform_fee,
                gift_wrap: data.totals.gift_wrap,
                discount: data.totals.coupon_discount,
                premium_discount: data.totals.premium_discount,
                total: data.totals.final_total
            });
            resetCouponUI();

        };
    });
  };
})

function markCouponApplied(code, discountAmount) {

    document.querySelectorAll('.apply-coupon-btn').forEach(btn => {
        const btnCode = btn.dataset.code;

        if (btnCode === code) {
            btn.textContent = 'Remove';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-danger', 'remove-coupon-btn');
            btn.classList.remove('apply-coupon-btn');
            btn.dataset.applied = 'true';
        } else {
            btn.disabled = true;
        }
    });

    // ‚úÖ Success message
    const msg = document.getElementById('coupon-success-msg');
    if (msg) {
        msg.innerHTML = `üéâ You saved <strong>‚Çπ${discountAmount}</strong> with this coupon!`;
        msg.style.display = 'block';
    }

    const row = document.getElementById('coupon-discount-row');
    if (row) row.style.display = 'flex';
}
function resetCouponUI() {
    document.querySelectorAll('button[data-applied="true"]').forEach(btn => {
        btn.textContent = 'Apply Coupon';
        btn.classList.remove('btn-danger', 'remove-coupon-btn');
        btn.classList.add('btn-outline-primary', 'apply-coupon-btn');
        btn.disabled = false;
        btn.removeAttribute('data-applied');
    });

    document.querySelectorAll('.apply-coupon-btn').forEach(btn => {
        btn.disabled = false;
    });

    // Hide discount row
    const row = document.getElementById('coupon-discount-row');
    if (row) row.style.display = 'none';

    // Hide success message
    const msg = document.getElementById('coupon-success-msg');
    if (msg) {
        msg.style.display = 'none';
        msg.innerHTML = '';
    }
}



</script>




<script>
// Connect to WebSocket for real-time updates
const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';

const cartSocket = new WebSocket(
    protocol +
    window.location.host +
    '/ws/cart/{{ request.user.id }}/'
);

cartSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    console.log('WebSocket message received:', data);

    document.querySelectorAll('.cart-count').forEach(el => {
        el.textContent = data.cart_count || '0';
    });

    if (data.action === 'remove') {
        const itemElement = document.querySelector(`[data-item-id="${data.item_id}"]`);
        if (itemElement) {
            itemElement.closest('.d-flex.p-3.mb-3').remove();
        }

        showToast('Item removed from cart');

        if (data.is_empty) {
            setTimeout(() => location.reload(), 1000);
        }

    } else if (data.action === 'update') {
        const itemElement = document.querySelector(`[data-item-id="${data.item_key}"]`);
        if (itemElement) {
            const quantityElement = itemElement.querySelector('.quantity-value');
            if (quantityElement) {
                quantityElement.textContent = data.quantity;
            }
        }
    }
};

cartSocket.onclose = function (e) {
    console.error('Cart socket closed unexpectedly:', e);
};


// Helper function to show toast messages
function showToast(message) {
    const toast = document.getElementById('toast');
    if (toast) {
        toast.querySelector('.toast-body').textContent = message;
        toast.style.display = "block";
        setTimeout(() => {
            toast.style.display = "none";
        }, 2000);
    }
}
</script>





<script src="https://cdn.jsdelivr.net/npm/canvas-confetti"></script>

  


  
{% endblock content %}
