 {% extends 'layouts/main.html' %}
{% load static %}
{% block title %}
{% endblock title %}

{% block extra_css %}
<!-- <link rel="stylesheet" href="{% static 'css/home.css' %}?v2" type="text/css" /> -->

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
/* --- Card and Grid Styling --- */
.filter-box {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 0 !important;
 
    border: 1.5px solid #D8CBBD;
    background: #FBF0EF;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease-in-out;
    position: relative;
    z-index: 1;
    transform-origin: center;
    opacity: 1 !important;
    margin: 0 !important;
    cursor: pointer;
}
.filter-box:hover {
    transform: translateY(-5px) scale(1.05);
    cursor: pointer;
    z-index: 3;
  } 
.filter-img {
    display: flex;
    align-items: stretch;
    justify-content: center;
    height: 298px;
    padding: 0;
    margin: 0;
    overflow: hidden;
    border-radius: 10px 10px 0 0;
    background: #FBFAF4;
    position: relative;
}
.card-img-top.main-img,
.card-img-top.hover-img {
    height:298px;
    overflow: hidden;
   
    position: relative;

}
.card-img-top.hover-img {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
}
.filter-img:hover .main-img { display: none; }
.filter-img:hover .hover-img { display: block; }

.filter-body { 
        background-color: #FBF0EF;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease-in-out;
}
.filter-title {
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Limit to 2 lines */
    line-clamp: 2; /* Standard property for compatibility */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #4D4D4D;
    font-size: 16px;
    font-family: Jomolhari;
    font-weight: 400;
    text-transform: capitalize;

    word-wrap: break-word;
    margin: 0;
    max-width: 100%;
    margin-top: 30px;
    line-height: 22px;
}
.filter-text {
    color: #4D4D4D;
    font-size: calc(12px + 0.3vw);
    font-family: Jomolhari;
    font-weight: 400;
    text-transform: capitalize;
    line-height: 30px;
    margin: 0;
}

/* .favorite {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border: 1px solid #f1eeee;
    border-radius: 50%;
    display: none;   
    justify-content: center;
    align-items: center;
    background: transparent;
    z-index: 5;
    cursor: pointer;
} */

/* Show favorite when hovering card */
.favorite {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border: 1px solid #ccc;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: transparent;
    z-index: 5;
    cursor: pointer;
    transition: all 0.3s ease;
}
.filter-box:hover .favorite,
.product-card:hover .favorite ,.product-Grid:hover .favorite {
    display: flex;
}


.favorite img {
    width: 20px;
    height: 20px;
    filter: grayscale(100%); /* default grey heart */
    transition: all 0.3s ease;
}

.favorite.active {
    border-color: #e63946;
    background: #cf0d78;
}

.favorite.active img {
    filter: none; /* show real color */
}



.cart {
            display: none;
        position: absolute;
        bottom:0px;
        /* Position at bottom of image container */
        left: 51%;
        transform: translateX(-50%);
        background-color: #6D3F0BF2;
        color: white;
        height: 55px;
        width: calc(111% - 20px);
        /* Full width minus padding */
        justify-content: center;
        gap: 12px;
        align-items: center;
        z-index: 2;
        font-size: 18px;
        font-family: Jomolhari;
        text-transform: capitalize;
}
.filter-box:hover .cart { display: flex; }

.blurred-image {
    filter: blur(2px);
    opacity: 0.6;
    pointer-events: none;
}
.out-of-stock-cross {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    background-color: rgba(220, 53, 69, 0.9);
    color: white;
    padding: 8px 25px;
    font-size: 0.9rem;
    font-weight: bold;
    border-radius: 5px;
    z-index: 10;
    text-transform: uppercase;
    pointer-events: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

/* --- Responsive Grid --- */
#productGrid.row {
    margin-right: 0 !important;
    margin-left: 0;
    overflow: visible;
    display: flex;
    flex-wrap: wrap;
    justify-content: center !important;
}
#productGrid [class^="col-"] {
    padding: 0 8px;
    margin-bottom: 16px;
}

@media (max-width: 576px) {
    #productGrid .col-12,
    #productGrid .col-6,
    #productGrid .col-sm-6,
    #productGrid .col-md-6 {
        flex: 0 0 50% !important;
        max-width: 50% !important;
    
    }
     .cart {
        width: 100% !important;
        left: 50% !important;
       
    }
    .favorite, .badge-rating {
        z-index: 5;
    }
    .filter-box {
        overflow: hidden;
        position: relative;
        width: 100% !important;
        height: 100% !important;
        left: -15px;
    }

    .filter-img{
        position: relative;
        height:auto; /* Adjust for mobile */
        overflow: hidden;
    }
    .card-img-top.main-img,
    .card-img-top.hover-img {
        height: 100%;
        width: 100%;
        object-fit: cover;
        border-radius:0px;
    }
    .card-img-top.hover-img {
    display: none;
    position: static; /* or remove position entirely */
}

   
}

@media (min-width: 576px) and (max-width: 767.98px) {
    #productGrid .col-sm-4 {
        flex: 0 0 33.333%;
        max-width: 33.333%;
    }
    .card-img-top { height: 200px; }
}
@media (min-width: 768px) and (max-width: 991.98px) {
    #productGrid .col-12,
    #productGrid .col-sm-6,
    #productGrid .col-md-6,
    #productGrid .col-lg-4,
    #productGrid .col-xl-4 {
        flex: 0 0 50% !important;
        max-width: 50% !important;
    }
    #productGrid .col-md-6 {
        padding-left: 20px !important;
        padding-right: 20px !important;
        margin-bottom: 32px !important;
    }
    .card-img-top { height: 220px; }
}
@media (min-width: 992px) and (max-width: 1199.98px) {
    #productGrid .col-lg-4, #productGrid .col-xl-4 {
        flex: 0 0 33.333% !important;
        max-width: 33.333% !important;
    }
    .filter-box {
        max-width: 340px !important;
        margin-left: auto;
        margin-right: auto;
    }
    .card-img-top { height: 240px; }
}
@media (min-width: 1200px) {
    #productGrid .col-xl-2 {
        flex: 0 0 16.666%;
        max-width: 16.666%;
    }
    .card-img-top { height: 260px; }
}
@media (max-width: 1024px) {
    .sidebar-filter-desktop { display: none !important; }
    .filter-btn-mobile, .d-flex.justify-content-center.my-3.w-100.d-lg-none {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        margin: 20px auto 10px auto !important;
        width: 100% !important;
    }
    .right { width: 100% !important; left: 0 !important; position: static !important; margin: 0 auto !important; display: flex;justify-content: center; align-items: center; }
    .filter-btn-mobile { display: flex !important; }
    #productGrid .col-12, #productGrid .col-sm-6, #productGrid .col-md-6, #productGrid .col-lg-4, #productGrid .col-xl-4 {
        flex: 0 0 50% !important;
        max-width: 90% !important;
    }
}
@media (max-width: 768px) {
    #productGrid .col-12, #productGrid .col-sm-6, #productGrid .col-md-6, #productGrid .col-lg-4, #productGrid .col-xl-4 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
    }
    .perfume-title {
        font-size: 36px;
        line-height: 40px;
        margin-left: 0;
    }
    .logo img { margin-left: 20px; }
    .nav-item { font-size: 16px; }
    .icons img { width: 20px; height: 20px; }
    .banner { height: 100px; }
    .subcategory-banner { width:150%; }
}

/* --- Utility and Misc --- */
.img-fluid1{ height: 10px; width: 10px; }
.navbar-toggler{ margin-left: 10px; margin-bottom: 10px; }
.navbar-nav{ margin-left: 10px; }
.icons img { width: 24px; height: 24px; }
.img-fluid{ width: 169px; height: 96px; }
.perfume-title {
    color: white;
    font-size: 56px;
    font-family: Jomolhari, serif;
    font-weight: 400;
    line-height: 58px;
    text-align: center;
    position: absolute;
    top: 50%;
    left: 60%;
    transform: translate(-50%, -50%);
}

/* --- Filter/Sidebar/Dropdown --- */
#selectedFilters { display: flex; flex-wrap: wrap; gap: 10px; }
.filter-item1 {
    background-color: white;
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 100%;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
.clear-all, .clearAll {
    color: #6D3F0B;
    font-size: 16px;
    font-weight: 500;
    line-height: 18px;
    text-decoration: none;
    text-align:right;
    padding-right:25px;
    cursor: pointer;
}

/* --- Offer/Badge/Rating --- */
.offer-info-bar {
    position: absolute;
    top: -1px;
    /* ensure it can stretch */
    left: 1px;
    padding: 0;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between; /* this separates left and right items */
    font-size: 12px;
    color: maroon;

    z-index: 10;
    white-space: nowrap;
    width: auto; /* optional: fit parent width */
}

.discount-percentage {
    display: inline-block;
    background: linear-gradient(90deg, #016b03 0%, #016b03 100%);
    color: #fff;
    font-size: 0.85rem;
    font-family: 'SF Pro Display', 'Jomolhari', Arial, sans-serif;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 16px 16px 16px 0;
    box-shadow: 0 2px 8px rgba(255, 111, 0, 0.15);
    letter-spacing: -0.5px;
    margin-left: 8px;
    margin-top: 2px;
    vertical-align: middle;
    min-width: 60px;
    text-align: center;
    border: 2px solid #fff3e0;
    position: relative;
    z-index: 2;
    transition: background 0.2s;
}
@media (max-width: 576px) {
    .discount-percentage {
        font-size: 0.60rem;
        padding: 3px 8px;
        border-radius: 12px 12px 12px 0;
        min-width: 50px;
        margin-left: 4px;
    }
}
@media (max-width: 400px) {
    .discount-percentage {
        font-size: 0.60rem;
        padding: 2px 6px;
        min-width: 50px;
    }
}

.aa {
    font-family: monospace;
    background-color: #981945;
    color: #f5f3f3;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: -4px;
}

.badge-rating {
    position: absolute;

    right: 10px;
    background-color: #ecebe7;
    color: #333;
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 0.8rem;
    z-index: 2;
    font-weight: 600;
    box-shadow: 0 0 4px rgba(0,0,0,0.1);
    
}
.filter-box:hover .badge-rating { z-index: 5; opacity: 1; }


/* --- Banner --- */
.banner-container {
    position: relative;
    text-align: center;
    overflow: hidden;
    height: 130px;
}
.banner-container img { width: 100%; object-fit: cover; }
.banner-title {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 2rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    background-color: rgba(0, 0, 0, 0.4);
    padding: 10px;
    max-width: 90%;
}

/* --- Miscellaneous --- */
.font-jomolhari { font-family: 'Jomolhari', serif; }
.font-sf-pro { font-family: 'SF Pro Display', sans-serif; }

html, body {
    overflow-x: hidden;
    max-width: 100%;
}

</style>
<style>
.blurred {
  filter: blur(2px);
  pointer-events: none;
  user-select: none;
  opacity: 0.8;
}

.out-of-stock-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(51, 51, 51, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #f7f2f2;
  font-size: 1.1rem;
  font-weight: 600;
  z-index: 10;
}

.product-card.disabled-card {
  cursor: not-allowed;
}

.product-card.disabled-card:hover .hover-img {
  display: none;
}

.product-title, .product-price {
  font-size: 0.9rem;
}

.text-muted {
  color: #888 !important;
  font-size:12px;
}

.add-to-cart-btn {
  transition: all 0.3s ease;
}

/* Low Stock blinking */
.low-stock-blink {
  position: absolute;
  top: 10px;
  left: 10px;
  background-color: #ffc107;
  color: black;
  padding: 0.3rem 0.6rem;
  border-radius: 8px;
  font-size: 1rem;
  animation: blink 1s infinite;
  z-index: 10;
}

@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.2; }
  100% { opacity: 1; }
}
.right,
.container-fluid,
#productGrid {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Common Badge Style */
.badge-best_seller,
.badge-trending,
.badge-new {
  position: absolute;
  left: 1px; /* Always starts from the left edge */
  color: #fff;
  font-size: clamp(10px, 1.5vw, 13px); /* Scales with screen size */
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 600;
  white-space: nowrap;
  z-index: 2;
}

/* Individual Badge Colors & Vertical Stacking */
.badge-best_seller {
  background: #981945;
  top: 20px;
}

.badge-trending {
  background: #981945;
  top: 20px; /* slightly lower than best seller */
}

.badge-new {
  background: #981945;
  top: 20px; /* slightly lower than trending */
}

/* Small Screens: Reduce Size & Spacing */
@media (max-width: 480px) {
  .badge-best_seller,
  .badge-trending,
  .badge-new {
    font-size: clamp(9px, 3vw, 11px);
    padding: 3px 6px;
  }
  .badge-trending { top: 20px; }
  .badge-new { top: 20px; }
}

.filter-card{
    padding:10px;
    background-color:#FBF0EF ;
}
.loader {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #FF6B6B; /* spinner color */
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin: auto;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

</style>
{% endblock extra_css %}

{% block content %}
</head>
<body>
    <div class="container-fluid p-0">
        <!-- Display Category Banner with Name Overlay -->
        <div id="category-banner" class="banner-container">
            <!-- Category Banner will be dynamically inserted here -->
        </div>
        <div id="subcategory-banner" class="banner-container">
            <!-- Subcategory Banner will be dynamically inserted here -->
        </div>
        <!-- Mobile & Tablet Filter Button (centered, always visible on <=1024px) -->
<div class="d-flex justify-content-center my-3 w-100 d-lg-none">
  <button class="btn px-4 py-2 text-white" style="background-color:#981945" data-bs-toggle="modal" data-bs-target="#filterModal">
    <i class="bi bi-funnel"></i> Filter
  </button>
</div>

        <!-- Main Content -->
        <div class="container-fluid" style="background-color:#F7E7E8;">
            <div class="row">
                <!-- Sidebar filter: only visible above 1024px, no Bootstrap d-none/d-lg-block -->
                <div class="col-sm-10 col-md-3 sidebar-filter-desktop"> <!-- Only visible above 1024px by custom CSS -->
                    <div class="dropdown-container mt-3" style="background-color:#FBF0EF; border-radius: 8px; border-color: black;">
                        <!-- Sidebar filter content START -->
                        <div class="mb-4">
                            <div class="dropdown">
                                <button class="btn dropdown-toggle filter-btn w-100 d-flex justify-content-between align-items-center" type="button" id="sortByDropdown" style="background-color: none;"  data-bs-toggle="dropdown" aria-expanded="false">
                                    Sort By
                                </button>
                            </div>
                        </div>
                        <div id="sortByContent" class="dropdown-content">
                            <div class="d-flex flex-row justify-content-between align-items-center p-3 w-100">
                                <div class="text-black fs-5 fw-normal font-jomolhari">Filter</div>
                                <div class="text-secondary fs-6 fw-normal font-jomolhari">160 products</div>
                            </div>
                            <div class="filter-container p-3" style="background-color: #fff1f0; border-radius: 10px;">
                                <div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
                                    <div id="selectedFilters" class="d-flex flex-wrap gap-2"></div>
                                    <button id="clearAllFilters" class="btn btn-outline-danger btn-sm">Clear All</button>
                                </div>
                            </div>
                            <!-- Dropdown for Category -->
                            <div class="mb-4 mt-3">
                                <div class="dropdown">
                                    <button class="btn dropdown-toggle filter-btn w-100 d-flex justify-content-between align-items-center" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        Category
                                    </button>
                                </div>
                                <div id="categoryContent" class="drpdwn" style="display: none;">
                                    <ul class="w-100" aria-labelledby="categoryDropdown" style="list-style-type:none;">
                                        {% for cat in navbar_categories %}
                                        <li>
                                            <label class="dropdown-item d-flex align-items-center">
                                                <input class="form-check-input me-2 categoryFilter" type="checkbox" value="{{ cat.id }}" {% if cat.id == category.id %}selected{% endif %} id="cat{{ cat.id }}" data-name="{{ cat.name }}">
                                                {{ cat.name }}
                                            </label>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <!-- Brand -->
                            <div class="mb-4">
                                <div class="dropdown">
                                    <button class="btn dropdown-toggle filter-btn w-100 d-flex justify-content-between align-items-center" type="button" id="brandDropdown">
                                        Collections
                                    </button>
                                </div>
                                <div id="brandContent" class="drpdwn mt-2" style="display: none;">
                                    <ul class="w-100 ps-0" style="list-style-type:none;">
                                        {% for sub in subcategories %}
                                        <li>
                                            <label class="dropdown-item d-flex align-items-center">
                                                <input class="form-check-input me-2 subcategoryFilter" type="checkbox" value="{{ sub.id }}" {% if sub.id == subcategory.id %}selected{% endif %}id="sub{{ sub.id }}" data-name="{{ sub.name }}">
                                                {{ sub.name }}
                                            </label>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <!-- Dropdown for Size -->
                            <div class="mb-4">
                                <div class="dropdown">
                                    <button class="btn dropdown-toggle filter-btn w-100 d-flex justify-content-between align-items-center" type="button" id="sizeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        Size
                                    </button>
                                </div>
                                <div id="sizeContent" class="drpdwn" style="display: none;">
                                    <ul class=" w-100" aria-labelledby="categoryDropdown" style="list-style-type:none;">
                                        {% for size in sizes %}
                                        <li>
                                            <label class="dropdown-item d-flex align-items-center">
                                                <input class="form-check-input me-2 sizeFilter" type="checkbox" value="{{ size }}" id="size{{ size }}" data-name="{{ size }}">
                                                {{ size }}
                                            </label>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <!-- Dropdown for Price -->
                            <div class="mb-4">
                                <div class="dropdown">
                                    <button class="btn dropdown-toggle filter-btn w-100 d-flex justify-content-between align-items-center" type="button" id="priceDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        Price range
                                    </button>
                                </div>
                                <div id="priceContent" style="display: block;">
                                    <input type="range" class="custom-range" id="priceRange" min="{{ min_price }}" max="{{ max_price }}" value="{{ max_price }}" step="10" style="width:90%;">
                                    <div class="mt-2 text-center">
                                        <span>₹<span id="priceRangeValue">{{ max_price }}</span></span>
                                    </div>
                                </div>
                            </div>
                            <!-- Discount -->
                            
                        </div>
                        <!-- Sidebar filter content END -->
                    </div>
                </div>
                <!-- Right Section -->
                <div class="right col-md-8 ms-3">
                    <div class="container-fluid px-0">
                        <div class="row g-4 mb-5 mt-2" id="productGrid">   
    </div>
    <div id="infiniteLoader" style="display:none; text-align:center; margin:20px 0;">
    <div class="loader"></div>
</div>


</div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->

        <!-- End Text -->
        
    </div>

    <style>
        /* Filter dropdown buttons – force clean look */
        .filter-btn {
            background-color: transparent !important;
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            color: #000 !important;
            font-family: 'Jomolhari';
            font-size: 20px;
           
        }

        /* Prevent Bootstrap active/focus background */
        .filter-btn:focus,
        .filter-btn:active,
        .filter-btn.show {
           
            box-shadow: none !important;
        }

        .filter-btn:hover {
            background-color: #981945 !important;
            color: #fff !important;
}


    </style>

    <!-- Bootstrap JS -->
    <script>
        document.getElementById("sortByDropdown").addEventListener("click", function() {
            if (window.innerWidth <= 768) {
                const content = document.getElementById("sortByContent");
                const currentDisplay = content.style.display;
                content.style.display = (currentDisplay === "none" || currentDisplay === "") ? "block" : "none";
            }
            
        });
        
        document.getElementById("categoryDropdown").addEventListener("click", function() {
            const content = document.getElementById("categoryContent");
            const currentDisplay = content.style.display;
            content.style.display = (currentDisplay === "none" || currentDisplay === "") ? "block" : "none";
        });
        
        document.getElementById("sizeDropdown").addEventListener("click", function() {
            const content = document.getElementById("sizeContent");
            const currentDisplay = content.style.display;
            content.style.display = (currentDisplay === "none" || currentDisplay === "") ? "block" : "none";
        });
        
        document.getElementById("priceDropdown").addEventListener("click", function() {
            const content = document.getElementById("priceContent");
            const currentDisplay = content.style.display;
            content.style.display = (currentDisplay === "none" || currentDisplay === "") ? "block" : "none";
        });

        document.getElementById("brandDropdown").addEventListener("click", function() {
            const content = document.getElementById("brandContent");
            const currentDisplay = content.style.display;
            content.style.display = (currentDisplay === "none" || currentDisplay === "") ? "block" : "none";
        });

        
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let currentPage = 1;
let loading = false;
let hasNext = true;
let loadedProductIds = new Set(); // Prevent duplicate products

/* ------------------------------
   GET URL PARAMETERS
------------------------------ */
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        categories: params.getAll('category').length ? params.getAll('category') : (params.get('categories') ? params.get('categories').split(',') : []),
        subcategories: params.getAll('subcategory').length ? params.getAll('subcategory') : (params.get('subcategories') ? params.get('subcategories').split(',') : []),
        sizes: params.getAll('size'),
        min_price: params.get('min_price') || 0,
        max_price: params.get('max_price') || null,
        page: params.get('page') || 1
    };
}

/* ------------------------------
   APPLY FILTERS FROM URL
------------------------------ */
(function applyFiltersFromURL() {
    const urlParams = getUrlParams();

    urlParams.categories.forEach(id => {
        $(`.categoryFilter[value="${id}"]`).prop("checked", true);
        $(`.categoryFilterModal[value="${id}"]`).prop("checked", true);
    });

    urlParams.subcategories.forEach(id => {
        $(`.subcategoryFilter[value="${id}"]`).prop("checked", true);
        $(`.subcategoryFilterModal[value="${id}"]`).prop("checked", true);
    });

    urlParams.sizes.forEach(id => {
        $(`.sizeFilter[value="${id}"]`).prop("checked", true);
        $(`.sizeFilterModal[value="${id}"]`).prop("checked", true);
    });

    if (urlParams.max_price) {
        $("#priceRange").val(urlParams.max_price).trigger("input");
        $("#priceRangeModal").val(urlParams.max_price).trigger("input");
    }
    if (urlParams.min_price) {
        $("#priceRangeMin").val(urlParams.min_price);
    }

    // Set initial page
    currentPage = parseInt(urlParams.page);

    // Expand dropdowns if something is auto-checked
    if (urlParams.categories.length > 0) $("#categoryDropdownModal").click();
    if (urlParams.subcategories.length > 0) $("#brandDropdownModal").click();
})();

/* ------------------------------
   UPDATE URL DYNAMICALLY
------------------------------ */
function updateURL() {
    const categories = $('.categoryFilter:checked').map(function(){ return $(this).val(); }).get();
    const subcategories = $('.subcategoryFilter:checked').map(function(){ return $(this).val(); }).get();
    const sizes = $('.sizeFilter:checked').map(function(){ return $(this).val(); }).get();
    const min_price = $('#priceRangeMin').val();
    const max_price = $('#priceRange').val();

    const params = new URLSearchParams();

    if(categories.length) params.set('categories', categories.join(','));
    if(subcategories.length) params.set('subcategories', subcategories.join(','));
    if(sizes.length) params.set('size', sizes.join(','));
    if(min_price && min_price != 0) params.set('min_price', min_price);
    if(max_price && max_price != 0) params.set('max_price', max_price);
    if(currentPage > 1) params.set('page', currentPage);

    const newUrl = window.location.pathname + '?' + params.toString();
    window.history.replaceState({}, '', newUrl);
}

/* ------------------------------
   UPDATE SELECTED FILTERS UI
------------------------------ */
function updateSelectedFilters() {
    let filters = [];
    $('.categoryFilter:checked').each(function(){
        filters.push({ type: 'category', id: $(this).val(), name: $(this).data('name') });
    });
    $('.subcategoryFilter:checked').each(function(){
        filters.push({ type: 'subcategory', id: $(this).val(), name: $(this).data('name') });
    });
    $('.sizeFilter:checked').each(function(){
        filters.push({ type: 'size', id: $(this).val(), name: $(this).data('name') });
    });

    renderSelectedFilters(filters);
}

function renderSelectedFilters(filters) {
    let html = '';
    filters.forEach(filter => {
        html += `
        <div class="filter-item1 d-flex align-items-center justify-content-between gap-2">
            <div class="text-black font-jomolhari">${filter.name}</div>
            <img src="{% static 'images2/close_small.svg' %}" class="img-fluid remove-filter"
                 style="max-width: 20px; cursor:pointer;"
                 data-type="${filter.type}" data-id="${filter.id}">
        </div>`;
    });
    $('#selectedFilters').html(html);
}

/* ------------------------------
   RENDER PRODUCT CARD
------------------------------ */
function renderProduct(prod) {
    const discountPercentage =
  prod.is_offer_active && prod.discounted_price && prod.price
    ? Math.round(((prod.price - prod.discounted_price) / prod.price) * 100)
    : null;


    return `
    <div class="col-6 col-md-4 col-lg-3 mb-4">
<div class="filter-box position-relative product-card 
     ${prod.stock_status === 'Out of Stock' ? 'disabled-card' : ''}"
     data-product-id="${prod.id}"
     data-min-price="${prod.min_price}"
     data-max-price="${prod.max_price}"
     data-min-original="${prod.min_original_price}"
     data-max-original="${prod.max_original_price}">
        <div class="favorite ${prod.is_favorite ? 'active' : ''}" data-product-id="${prod.id}">
          <img src="{% static 'images2/favorite.svg' %}">
        </div>
        <div class="filter-img position-relative">
          <img src="${prod.image}" class="card-img-top main-img ${prod.stock_status === 'Out of Stock' ? 'blurred' : ''}">
          ${prod.image2 ? `<img src="${prod.image2}" class="card-img-top hover-img ${prod.stock_status === 'Out of Stock' ? 'blurred' : ''}">` : ''}
          ${prod.stock_status === 'Out of Stock' ? `<div class="out-of-stock-overlay"><span>Out of Stock</span></div>` : ''}
          ${prod.stock_status === 'Low Stock' ? `<span class="low-stock-blink">Low Stock</span>` : ''}
${prod.is_offer_active ? `
  <div class="offer-info-bar" id="offer-${prod.id}">
    <span class="offer-badge">
      <span id="countdown-${prod.id}" data-endtime="${prod.offer_end_time}"></span>
    </span>
  </div>` : ''}
          ${prod.is_best_seller ? `<span class="badge badge-best_seller">⚡Bestseller</span>` : ''}
          ${prod.is_trending ? `<span class="badge badge-trending">⚡Trending</span>` : ''}
          ${prod.is_new_arrival ? `<span class="badge badge-new">⚡New Arrival</span>` : ''}
          <a href="/product/${prod.id}/"><div class="cart"><img src="{% static 'images2/shopping_cart.svg' %}"> Add to Cart</div></a>
        </div>
        <div class="filter-card">
          <span class="badge-rating">
            <i class="bi bi-star-fill" style="color:#AF9164;"></i>
            ${(prod.average_rating ?? 0).toFixed(1)} | ${prod.review_count || 0}
          </span>
          <h5 class="filter-title">${prod.name}</h5>
          ${prod.is_offer_active ? `
  <div class="d-flex align-items-center mb-2">
    <p class="filter-text text-danger fw-bold">₹${prod.discounted_price}</p>
    <p class="text-muted mb-0"><del>₹${prod.price}</del></p>
    <span class="discount-percentage">${discountPercentage}% OFF</span>
  </div>
` : `
  <div class="d-flex align-items-center mb-2">
    <p class="filter-text fw-bold text-danger">
      ₹${prod.min_price} - ₹${prod.max_price}
      <span style="text-decoration:line-through;color:#777;margin-left:5px;">
        ₹${prod.min_original_price} - ₹${prod.max_original_price}
      </span>
    </p>
  </div>
`}

        </div>
      </div>
    </div>`;
}

/* ------------------------------
   LOAD PRODUCTS VIA AJAX
------------------------------ */
function loadProducts(append = false) {
    if (loading || (!hasNext && append)) return;
    loading = true;
    $("#infiniteLoader").show();

    const urlParams = getUrlParams();
    const categories = $('.categoryFilter:checked').map(function(){ return $(this).val(); }).get() || urlParams.categories;
    const subcategories = $('.subcategoryFilter:checked').map(function(){ return $(this).val(); }).get() || urlParams.subcategories;
    const sizes = $('.sizeFilter:checked').map(function(){ return $(this).val(); }).get() || urlParams.sizes;
    const max_price = $('#priceRange').val() || urlParams.max_price;
    const min_price = $('#priceRangeMin').val() || urlParams.min_price || 0;

    $.ajax({
        url: "{% url 'ajax_filter_products' %}",
        data: {
            page: currentPage,
            "category[]": categories,
            "subcategory[]": subcategories,
            "size[]": sizes,
            min_price: min_price,
            max_price: max_price
        },
        dataType: "json",
        success: function(res){
            if (!append) {
                $("#productGrid").empty();
                loadedProductIds.clear();
            }

            res.products.forEach(prod => {
                if (!loadedProductIds.has(prod.id)) {
                    $("#productGrid").append(renderProduct(prod));
                    loadedProductIds.add(prod.id);
                }
            });

            hasNext = res.has_next;
            if (hasNext) currentPage = res.next_page;

            // Update banners
            if (res.category_banner_url) $('#category-banner').html(`<img src="${res.category_banner_url}" class="img-fluid">`).show();
            else $('#category-banner').hide();
            if (res.subcategory_banner_url) $('#subcategory-banner').html(`<img src="${res.subcategory_banner_url}" class="img-fluid">`).show();
            else $('#subcategory-banner').hide();

            startCountdowns();
            updateURL(); // ✅ Update URL after loading products
        },
        complete: function(){ loading = false; $("#infiniteLoader").hide(); }
    });
}

/* ------------------------------
   RESET FILTERS
------------------------------ */
function resetFilters() {
    currentPage = 1;
    hasNext = true;
    loadedProductIds.clear();
    updateSelectedFilters();
    loadProducts(false);
}

/* ------------------------------
   COUNTDOWN TIMER
------------------------------ */
function startCountdowns() {
  document.querySelectorAll('[id^="countdown-"]').forEach(el => {
    const endTimeStr = el.getAttribute('data-endtime');
    if (!endTimeStr) return;

    const endTime = new Date(endTimeStr).getTime();
    const card = el.closest('.filter-box');
    if (!card) return;

    const interval = setInterval(() => {
      const now = Date.now();
      const dist = endTime - now;

      // ⛔ OFFER EXPIRED
      if (dist <= 0) {
        clearInterval(interval);

        // 1️⃣ Remove offer bar
        const offerBar = card.querySelector('.offer-info-bar');
        if (offerBar) offerBar.remove();

        // 2️⃣ Replace discounted price with normal price
        const priceBlock = card.querySelector('.filter-card .d-flex');
        if (priceBlock) {
          const minPrice = card.dataset.minPrice;
          const maxPrice = card.dataset.maxPrice;
          const minOrig = card.dataset.minOriginal;
          const maxOrig = card.dataset.maxOriginal;

          priceBlock.innerHTML = `
            <p class="filter-text fw-bold text-danger">
              ₹${minPrice} - ₹${maxPrice}
              <span style="text-decoration:line-through;color:#777;margin-left:5px;">
                ₹${minOrig} - ₹${maxOrig}
              </span>
            </p>`;
        }

        // 3️⃣ Optional visual cue
        card.classList.add('offer-expired');
        return;
      }

      // ⏳ Update countdown
      const d = Math.floor(dist / (1000 * 60 * 60 * 24));
      const h = Math.floor((dist / (1000 * 60 * 60)) % 24);
      const m = Math.floor((dist / (1000 * 60)) % 60);
      const s = Math.floor((dist / 1000) % 60);

      el.innerText = `⚡ ${d}d ${h}h ${m}m ${s}s`;
    }, 1000);
  });
}


/* ------------------------------
   INFINITE SCROLL
------------------------------ */
$(window).on("scroll", function() {
    if (loading || !hasNext) return;
    let $lastProduct = $("#productGrid .product-card").last();
    if ($lastProduct.length === 0) return;
    const lastProductBottom = $lastProduct.offset().top + $lastProduct.outerHeight();
    const scrollBottom = $(window).scrollTop() + $(window).height();
    if (scrollBottom >= lastProductBottom - 200) {
        loadProducts(true);
        updateURL(); // ✅ Update URL with current page
    }
});

/* ------------------------------
   DOCUMENT READY
------------------------------ */
$(document).ready(function() {
    resetFilters();

    // Filter listeners
    $('.categoryFilter, .subcategoryFilter, .sizeFilter').on('change', function() {
        resetFilters();
        updateURL();
    });

    $('#priceRange, #priceRangeMin').on('input change', function() {
        $('#priceRangeValue').text($('#priceRange').val());
        resetFilters();
        updateURL();
    });

    // Remove individual filters
    $(document).on('click', '.remove-filter', function() {
        const type = $(this).data('type');
        const id = $(this).data('id');
        $(`.${type}Filter[value="${id}"]`).prop("checked", false);
        resetFilters();
        updateURL();
    });

    // Clear all filters
    $("#clearAllFilters").click(function(){
        $('.categoryFilter, .subcategoryFilter, .sizeFilter').prop("checked", false);
        $('#priceRange').val(0); $('#priceRangeValue').text(0);
        resetFilters();
        updateURL();
    });

    // Modal toggles
    $('#categoryDropdownModal').click(() => $('#categoryContentModal').slideToggle(150));
    $('#brandDropdownModal').click(() => $('#brandContentModal').slideToggle(150));
    $('#sizeDropdownModal').click(() => $('#sizeContentModal').slideToggle(150));
    $('#priceRangeModal').on('input', function(){ $('#priceRangeValueModal').text(this.value); });

    // Apply modal filters
    $('#applyFiltersModal').click(function () {
        $('.categoryFilter').prop('checked', false);
        $('.categoryFilterModal:checked').each(function() { $('.categoryFilter[value="' + $(this).val() + '"]').prop('checked', true); });

        $('.subcategoryFilter').prop('checked', false);
        $('.subcategoryFilterModal:checked').each(function() { $('.subcategoryFilter[value="' + $(this).val() + '"]').prop('checked', true); });

        $('.sizeFilter').prop('checked', false);
        $('.sizeFilterModal:checked').each(function() { $('.sizeFilter[value="' + $(this).val() + '"]').prop('checked', true); });

        $('#priceRange').val($('#priceRangeModal').val()).trigger("input");

        const modalEl = document.getElementById('filterModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        $(modalEl).one('hidden.bs.modal', function(){
            resetFilters();
            $('body').removeClass('modal-open'); $('.modal-backdrop').remove(); $('body').css('overflow', '');
        });
        modalInstance.hide();
    });

    // Highlight dropdowns
    ["priceDropdown","sizeDropdown","brandDropdown","categoryDropdown","sortByDropdown"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.backgroundColor = "#FBF0EF";
    });
});
</script>


    <!-- Filter Modal for Mobile/Tablet -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true" >
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content" style="background-color: #FBF0EF;">
      <div class="modal-header">
        <h5 class="modal-title" style="font-family: 'Jomolhari'; font-size: 20px;">Filter Products</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"  >
        <!-- Category -->
        <div class="mb-3">
          <button class="btn dropdown-toggle filter-btn w-100" id="categoryDropdownModal">Category</button>
          <div id="categoryContentModal" class="mt-2" style="display:none;">
            <ul class="list-unstyled">
              {% for cat in navbar_categories %}
              <li>
                <label>
                  <input type="checkbox" class="form-check-input me-2 categoryFilterModal" value="{{ cat.id }}" data-name="{{ cat.name }}">
                  {{ cat.name }}
                </label>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <!-- Brand -->
        <div class="mb-3">
          <button class="btn dropdown-toggle filter-btn w-100" id="brandDropdownModal">Collections</button>
          <div id="brandContentModal" class="mt-2" style="display:none;">
            <ul class="list-unstyled">
              {% for sub in subcategories %}
              <li>
                <label>
                  <input type="checkbox" class="form-check-input me-2 subcategoryFilterModal" value="{{ sub.id }}" data-name="{{ sub.name }}">
                  {{ sub.name }}
                </label>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <!-- Size -->
        <div class="mb-3">
          <button class="btn dropdown-toggle filter-btn w-100" id="sizeDropdownModal">Size</button>
          <div id="sizeContentModal" class="mt-2" style="display:none;">
            <ul class="list-unstyled">
              {% for size in sizes %}
              <li>
                <label>
                  <input type="checkbox" class="form-check-input me-2 sizeFilterModal" value="{{ size }}" data-name="{{ size }}">
                  {{ size }}
                </label>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        <!-- Price Range -->
        <div class="mb-3">
          <label class="btn  filter-btn" >Price Range</label>
          <input type="range" id="priceRangeModal" min="{{ min_price }}" max="{{ max_price }}" value="{{ max_price }}">
          <div>₹<span id="priceRangeValueModal">{{ max_price }}</span></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn text-white" style="background-color:#981945" id="applyFiltersModal">Apply Filters</button>
      </div>
    </div>
  </div>
</div>


<!-- Bootstrap JS Bundle (for modal functionality) -->

{% endblock content %}