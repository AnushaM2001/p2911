{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{% if form.instance.id %}Update Address{% else %}Add Address{% endif %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #FAEBEA;
            max-width: 100vw;
            overflow-x: hidden;
        }
        .section-box {
            border: 1px dashed #bbb;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .form-label { font-weight: 500; }
        .btn-submit {
            width: 100%;
            background-color: #80002a;
            color: white;
            font-weight: bold;
            border-radius: 20px;
            transition: background 0.2s;
        }
        .btn-submit:hover { background-color: #a0003a; }
        .header-line { position: relative; padding: 0 40px; text-align: center; }
        .header-line h4.form-heading { margin: 0; display: inline-block; }
        .header-line a {
            position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            font-size: 0.95em; padding: 0.3em 0.7em; border-radius: 12px; transition: background 0.2s;
        }
        .header-line a:hover { background: #f8d7da; }
        .back-button {
            text-decoration: none; color: #333; font-weight: bold; margin-bottom: 1rem; display: inline-block;
        }
        .back-button:hover { color: #007bff; }
        .form-control.is-invalid { border-color: #dc3545; }
        .form-control.is-valid { border-color: #28a745; }
        @media (max-width: 768px) { .row > .col-md-6 { flex: 0 0 100%; max-width: 100%; } }
    </style>
</head>
<body>
<div class="container mt-4 mb-4">
    <a href="javascript:void(0);" onclick="window.history.back();" class="back-button">‚Üê Back</a>
    <form method="post" id="address-form" autocomplete="off">
        {% csrf_token %}
        <div class="header-line mb-3">
            <h4 class="form-heading">
                {% if form.instance.id %}Update Address{% else %}Add New Address{% endif %}
            </h4>
            <a href="#" onclick="document.getElementById('address-form').reset();" class="text-danger text-decoration-none">Reset</a>
        </div>

        <input type="hidden" name="next" value="{{ request.GET.next|default:request.META.HTTP_REFERER }}">

        <!-- Contact Info -->
        <div class="section-box">
            <h6 class="mb-3">Contact Info</h6>
            <div class="row g-2">
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">Address Category</label>
                    {{ form.address_category }}
                </div>
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">Name</label>
                    {{ form.Name }}
                </div>
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">Phone number (10 digits)</label>
                    {{ form.MobileNumber }}
                    <div id="mobileError" class="text-danger small mt-1"></div>
                </div>
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">Alternate Phone number (10 digits)</label>
                    {{ form.Alternate_MobileNumber }}
                    <div id="altMobileError" class="text-danger small mt-1"></div>
                </div>
            </div>
        </div>

        <!-- Address Info -->
        <div class="section-box">
            <h6 class="mb-3">Address Info</h6>
            <div class="row g-2">
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">Pincode</label>
                    {{ form.Pincode }}
                    <small id="pincodeError" class="text-danger" style="display:none;"></small>
                </div>
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">City</label>
                    {{ form.City }}
                </div>
            </div>
            <div class="row g-2">
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">State</label>
                    {{ form.State }}
                    <small id="stateError" class="text-danger" style="display:none;"></small>
                </div>
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">Locality / Area / Street / House No</label>
                    {{ form.location }}
                </div>
                <div class="col-md-6 col-12 mb-3">
                    <label class="form-label">Landmark (optional)</label>
                    {{ form.Landmark }}
                </div>
            </div>
        </div>

        <button type="submit" class="btn-submit py-2 mt-2">
            {% if form.instance.id %}Update address{% else %}Add address{% endif %}
        </button>
    </form>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    function validateMobile(inputId, errorId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        const category = document.getElementById("id_address_category");

        input.addEventListener("input", function () {
            let value = input.value.replace(/[^0-9]/g, ''); // allow only digits
            input.value = value;

            if (category.value === "national") {
                if (value.length === 0) {
                    error.textContent = "";
                    input.classList.remove("is-invalid", "is-valid");
                } else if (!/^[6-9]\d{9}$/.test(value)) {
                    error.textContent = "Enter a valid 10-digit number (starting 6-9)";
                    input.classList.add("is-invalid");
                    input.classList.remove("is-valid");
                } else {
                    error.textContent = "";
                    input.classList.add("is-valid");
                    input.classList.remove("is-invalid");
                }
            } else if (category.value === "international") {
                // International: numeric only, any length
                if (value.length === 0) {
                    error.textContent = "";
                    input.classList.remove("is-invalid", "is-valid");
                } else {
                    error.textContent = "";
                    input.classList.add("is-valid");
                    input.classList.remove("is-invalid");
                }
            }
        });

        // Re-validate when address category changes
        category.addEventListener("change", function () {
            input.dispatchEvent(new Event("input"));
        });
    }

    validateMobile("id_MobileNumber", "mobileError");
    validateMobile("id_Alternate_MobileNumber", "altMobileError");
});
</script>

   <script>
document.addEventListener("DOMContentLoaded", function () {
    const pincode = document.getElementById("id_Pincode");
    const state = document.getElementById("id_State");
    const category = document.getElementById("id_address_category");
    const pincodeError = document.getElementById("pincodeError");
    const stateError = document.getElementById("stateError");

    function validateForm() {
        let valid = true;
        const categoryVal = category.value;
        let pinValue = pincode.value;

        if (categoryVal === 'national') {
            // Only digits
            pinValue = pinValue.replace(/[^0-9]/g, '');
            pincode.value = pinValue;

            if (pinValue.length !== 6) {
                pincodeError.innerText = "Pincode must be exactly 6 digits for national address.";
                pincodeError.style.display = "block";
                pincode.classList.add("is-invalid");
                valid = false;
            } else {
                pincodeError.innerText = "";
                pincodeError.style.display = "none";
                pincode.classList.remove("is-invalid");
                pincode.classList.add("is-valid");
            }

            if (!state.value.trim()) {
                stateError.innerText = "State is required for national address.";
                stateError.style.display = "block";
                state.classList.add("is-invalid");
                valid = false;
            } else {
                stateError.innerText = "";
                stateError.style.display = "none";
                state.classList.remove("is-invalid");
                state.classList.add("is-valid");
            }
        } else if (categoryVal === 'international') {
            // Letters and digits allowed
            pinValue = pinValue.replace(/[^a-zA-Z0-9]/g, '');
            pincode.value = pinValue;

            pincodeError.innerText = "";
            pincodeError.style.display = "none";
            pincode.classList.remove("is-invalid");
            pincode.classList.add("is-valid");

            // State optional
            stateError.innerText = "";
            stateError.style.display = "none";
            state.classList.remove("is-invalid");
            state.classList.remove("is-valid");
        }

        return valid;
    }

    pincode.addEventListener("input", validateForm);
    state.addEventListener("input", validateForm);
    category.addEventListener("change", validateForm);

    document.getElementById("address-form").addEventListener("submit", function (e) {
        if (!validateForm()) e.preventDefault();
    });
});

</script>
</body>
</html>
