{% extends 'admin_panel/base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
<form method="get" class="d-flex gap-2 align-items-center mb-3">
  <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="ðŸ” Search..." />
  <input type="date" name="date" value="{{ selected_date }}" class="form-control" />
 {% if query or selected_date %}
<a href="?page={{ page_obj.number }}" class="btn btn-maroon">Clear Filters</a>
{% else %}
  <button type="submit" class="btn btn-maroon">Filter</button>
  
  {% endif %}
</form>      
    </div>
 <div class="text-end mb-2">
  <button class="btn btn-outline-success btn-sm d-flex align-items-center gap-1" style="float: right; margin-bottom: 10px;" onclick="exportWithImages()">
    <i class="bi bi-file-earmark-excel"></i> Export Excel
  </button>
</div> 
<h3>Help Queries</h3>

<table id="bannerTable" class="table">
    <thead>
        <tr>
            <th>User</th>
            <th>Subject</th>
            <th>Status</th>
            <th>Created</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for query in page_obj %}
        <tr>
            <td>{{ query.user.username }}</td>
            <td>{{ query.subject }}</td>
            <td>{{ query.status }}</td>
            <td>{{ query.created_at|date:"d M Y, H:i" }}</td>
            <td><a href="{% url 'admin_help_chat' query.id %}" class="btn btn-primary btn-sm">
    View / Reply
</a></td>
        </tr>
        {% empty %}
        <tr><td colspan="5">No help queries yet.</td></tr>
        {% endfor %}
    </tbody>
</table>
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
async function exportWithImages() {
    const table = document.getElementById("bannerTable");
    const rows = [...table.querySelectorAll("tr")];

    const data = [];
    const imageCells = [];

    rows.forEach((row, rIndex) => {
        const cells = [...row.querySelectorAll("th, td")];
        const rowData = [];

        cells.forEach((cell, cIndex) => {
            const img = cell.querySelector("img");

            if (img) {
                // ðŸ›‘ Skip ONLY settings.png image
                if (img.src.includes("settings.png")) {
                    rowData.push("");  // Keep empty cell
                } 
                else {
                    // âœ” Add all other images
                    imageCells.push({
                        row: rIndex + 1,
                        col: cIndex + 1,
                        src: img.src
                    });
                    rowData.push("");
                }
            } 
            else {
                rowData.push(cell.innerText.trim());
            }
        });

        data.push(rowData);
    });

    // Excel export using ExcelJS (your version)
    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet("Export");

    data.forEach((row, rIndex) => {
        sheet.addRow(row);
    });

    // Insert images except settings.png
    for (let item of imageCells) {
        const imgBlob = await fetch(item.src).then(res => res.blob());
        const buffer = await imgBlob.arrayBuffer();

        const imageId = workbook.addImage({
            buffer: buffer,
            extension: "png"
        });

        sheet.addImage(imageId, {
            tl: { col: item.col - 1, row: item.row - 1 },
            ext: { width: 80, height: 80 }
        });
    }

    // Download file
    workbook.xlsx.writeBuffer().then((buffer) => {
        const blob = new Blob([buffer], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        });
        saveAs(blob, "query_report.xlsx");
    });
}
</script>


{% endblock %}